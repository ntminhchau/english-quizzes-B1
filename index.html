<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B1 English Practice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* tr·∫°ng th√°i ƒë√°p √°n */
    .option-btn.correct { background-color:#22c55e !important; border-color:#16a34a !important; color:#fff !important; }
    .option-btn.incorrect { background-color:#ef4444 !important; border-color:#dc2626 !important; color:#fff !important; }
    .hidden { display:none; }
    /* loader s√°ng m√†u */
    .loader{ border:4px solid #e5e7eb; border-radius:50%; border-top:4px solid #06b6d4; width:40px; height:40px; animation:spin 2s linear infinite; }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    /* m√†u heading trong khu vi·∫øt */
    #writing-content-area h2{ font-size:1.5rem; font-weight:700; margin-bottom:1rem; color:#334155; }
    #writing-content-area h3{ font-size:1.25rem; font-weight:700; margin-top:1.25rem; margin-bottom:.5rem; color:#475569; }
    #writing-content-area p{ margin-bottom:1rem; line-height:1.7; color:#334155; }
    #writing-content-area ul{ list-style:disc; padding-left:1.25rem; margin-bottom:1rem; }
  </style>
</head>

<body class="bg-white text-slate-800 min-h-screen p-4">
  <div id="app-container" class="w-full max-w-5xl mx-auto">

    <!-- HOME -->
    <div id="home-screen" class="text-center bg-white border border-slate-200 p-8 rounded-2xl shadow-sm">
      <h1 class="text-4xl font-bold mb-2 text-sky-600">B1 English Practice</h1>
      <p class="text-slate-600 mb-8">Ch·ªçn m·ªôt m·ª•c ƒë·ªÉ luy·ªán t·∫≠p</p>
      <div class="flex flex-col gap-4 md:gap-6 justify-center">
        <button id="reading-vocab-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-5 px-8 rounded-xl text-xl md:text-2xl transition transform hover:scale-[1.02]">üß† Reading & Vocabulary Quizzes</button>
        <button id="speaking-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-5 px-8 rounded-xl text-xl md:text-2xl transition transform hover:scale-[1.02]">üó£Ô∏è Speaking Samples</button>
        <button id="writing-btn" class="bg-rose-600 hover:bg-rose-700 text-white font-semibold py-5 px-8 rounded-xl text-xl md:text-2xl transition transform hover:scale-[1.02]">‚úçÔ∏è Writing Samples</button>
      </div>
    </div>

    <!-- SPEAKING -->
    <div id="speaking-screen" class="hidden text-center bg-white border border-slate-200 p-8 rounded-2xl shadow-sm">
      <h2 class="text-3xl font-bold mb-6 text-indigo-600">Speaking Samples</h2>
      <div class="text-slate-700 bg-slate-50 border border-slate-200 p-6 rounded-xl min-h-[200px]">
        <p>N·ªôi dung ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t. Vui l√≤ng quay l·∫°i sau!</p>
      </div>
      <button class="back-to-home-btn mt-8 bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-6 rounded-lg">Quay v·ªÅ Trang ch√≠nh</button>
    </div>

    <!-- WRITING MENU -->
    <div id="writing-menu-screen" class="hidden text-center bg-white border border-slate-200 p-8 rounded-2xl shadow-sm">
      <h2 class="text-3xl font-bold mb-6 text-rose-600">Writing Samples</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button onclick="loadWritingContent('writing-samples/informal-letters.html','Th∆∞ Th√¢n M·∫≠t')" class="bg-slate-50 hover:bg-rose-50 border border-slate-200 hover:border-rose-300 p-6 rounded-xl text-lg">Informal Letters</button>
        <button onclick="loadWritingContent('writing-samples/formal-letters.html','Th∆∞ Trang Tr·ªçng')" class="bg-slate-50 hover:bg-rose-50 border border-slate-200 hover:border-rose-300 p-6 rounded-xl text-lg">Formal Letters</button>
        <button id="essays-menu-btn" class="md:col-span-2 bg-slate-50 hover:bg-rose-50 border border-slate-200 hover:border-rose-300 p-6 rounded-xl text-lg font-semibold">Essays</button>
      </div>
      <button class="back-to-home-btn mt-8 bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-6 rounded-lg">Quay v·ªÅ Trang ch√≠nh</button>
    </div>

    <!-- ESSAY MENU -->
    <div id="essay-menu-screen" class="hidden text-center bg-white border border-slate-200 p-8 rounded-2xl shadow-sm">
      <h2 class="text-3xl font-bold mb-6 text-rose-600">Essay Types</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button onclick="loadWritingContent('writing-samples/opinion-essay.html','Opinion Essay')" class="bg-slate-50 hover:bg-rose-50 border border-slate-200 hover:border-rose-300 p-4 rounded-xl">Opinion (Agree/Disagree)</button>
        <button onclick="loadWritingContent('writing-samples/discuss-essay.html','Discussion Essay')" class="bg-slate-50 hover:bg-rose-50 border border-slate-200 hover:border-rose-300 p-4 rounded-xl">Discuss Both Views</button>
        <button onclick="loadWritingContent('writing-samples/advantages-essay.html','Advantages/Disadvantages Essay')" class="bg-slate-50 hover:bg-rose-50 border border-slate-200 hover:border-rose-300 p-4 rounded-xl">Advantages & Disadvantages</button>
        <button onclick="loadWritingContent('writing-samples/two-part-essay.html','Two-Part Question Essay')" class="bg-slate-50 hover:bg-rose-50 border border-slate-200 hover:border-rose-300 p-4 rounded-xl">Two-Part Questions</button>
      </div>
      <button id="back-to-writing-menu-btn" class="mt-8 bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-6 rounded-lg">Quay l·∫°i Menu Writing</button>
    </div>

    <!-- WRITING CONTENT -->
    <div id="writing-content-screen" class="hidden bg-white border border-slate-200 p-8 rounded-2xl shadow-sm">
      <h2 id="writing-content-title" class="text-3xl font-bold mb-6 text-rose-600"></h2>
      <div id="writing-content-area" class="bg-slate-50 border border-slate-200 p-6 rounded-xl text-left max-h-[75vh] overflow-y-auto">
        <div class="loader mx-auto"></div>
      </div>
      <button id="back-to-writing-menu-from-content-btn" class="mt-8 bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-6 rounded-lg">Quay l·∫°i Menu Writing</button>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="hidden text-center bg-white border border-slate-200 p-8 rounded-2xl shadow-sm">
      <h1 class="text-4xl font-bold mb-2 text-sky-600">B1 English Quizzes</h1>
      <p class="text-slate-600 mb-6">Luy·ªán t·∫≠p Vocabulary & Reading m·ªói ng√†y!</p>
      <input id="name-input" type="text" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." class="w-full max-w-sm mx-auto bg-white text-slate-800 placeholder-slate-400 border border-slate-300 rounded-lg px-4 py-3 text-lg mb-4 focus:outline-none focus:ring-2 focus:ring-sky-400">
      <button id="login-btn" class="w-full max-w-sm mx-auto bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg text-lg transition">B·∫Øt ƒë·∫ßu</button>
    </div>

    <!-- CATEGORY -->
    <div id="category-selection-screen" class="hidden text-center bg-white border border-slate-200 p-8 rounded-2xl shadow-sm">
      <h2 class="text-3xl font-bold mb-8">Ch√†o <span id="user-name-display" class="text-sky-600"></span>, ch·ªçn m·ªôt chuy√™n m·ª•c:</h2>
      <div class="flex flex-col md:flex-row gap-4 md:gap-6 justify-center">
        <button id="vocab-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-5 px-8 rounded-xl text-xl transition">üìù Vocabulary</button>
        <button id="reading-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-5 px-8 rounded-xl text-xl transition">üìñ Reading</button>
      </div>
      <button id="back-to-home-from-category-btn" class="mt-8 bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-6 rounded-lg">Quay v·ªÅ Trang ch√≠nh</button>
    </div>

    <!-- QUIZ LIST -->
    <div id="quiz-list-screen" class="hidden text-center bg-white border border-slate-200 p-8 rounded-2xl shadow-sm">
      <h2 id="category-title" class="text-3xl font-bold mb-6 text-sky-700"></h2>
      <div id="quiz-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[150px] items-center justify-center">
        <div class="loader mx-auto"></div>
      </div>
      <div id="history-container" class="mt-8 text-left">
        <h3 class="text-2xl font-bold mb-4 text-slate-700">L·ªãch s·ª≠ l√†m b√†i (chuy√™n m·ª•c n√†y)</h3>
        <div id="history-list" class="bg-slate-50 border border-slate-200 p-4 rounded-xl max-h-60 overflow-y-auto"></div>
      </div>
      <button id="back-to-category-btn" class="mt-8 bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-6 rounded-lg">Quay l·∫°i</button>
    </div>

    <!-- QUIZ -->
    <div id="quiz-screen" class="hidden bg-white border border-slate-200 p-6 md:p-8 rounded-2xl shadow-sm">
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span id="quiz-title" class="text-xl md:text-2xl font-bold text-sky-700"></span>
          <span id="question-counter" class="text-lg font-semibold text-slate-700"></span>
        </div>
        <div class="w-full bg-slate-200 rounded-full h-4">
          <div id="progress-bar" class="bg-sky-500 h-4 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
      </div>

      <div class="text-center mb-6">
        <div id="timer" class="text-5xl font-bold text-amber-500">25</div>
      </div>

      <div id="question-container" class="mb-6">
        <div id="question-text" class="text-xl md:text-2xl text-center font-medium min-h-[100px] flex items-center justify-center text-slate-800"></div>
      </div>

      <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <!-- FEEDBACK MODAL -->
    <div id="feedback-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-[1px] flex items-center justify-center p-4">
      <div id="feedback-content" class="bg-white border border-slate-200 rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
        <h3 id="feedback-title" class="text-3xl font-bold mb-4 text-slate-800"></h3>
        <p id="feedback-explanation" class="text-lg text-slate-700"></p>
        <button id="next-question-btn" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-8 rounded-lg text-lg">Ti·∫øp theo</button>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="results-screen" class="hidden text-center bg-white border border-slate-200 p-8 rounded-2xl shadow-sm">
      <h2 class="text-4xl font-bold mb-4 text-sky-600">Ho√†n th√†nh!</h2>
      <p class="text-2xl mb-2 text-slate-800">K·∫øt qu·∫£ c·ªßa b·∫°n:</p>
      <p id="score-text" class="text-6xl font-bold mb-6 text-amber-500"></p>
      <p id="percentage-text" class="text-xl mb-8 text-slate-700"></p>
      <button id="back-to-menu-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg text-lg">Quay v·ªÅ Menu</button>
    </div>

  </div>

  <script>
  // ==== Gi·ªØ nguy√™n to√†n b·ªô JS g·ªëc c·ªßa b·∫°n ====
  const vocabularyQuizFiles = ['quizzes/vocabulary/cam18_t1.json','quizzes/vocabulary/cam18_t2.json','quizzes/vocabulary/cam18_t3.json'];
  const readingQuizFiles = [];

  const screens = {
    home: document.getElementById('home-screen'),
    speaking: document.getElementById('speaking-screen'),
    writingMenu: document.getElementById('writing-menu-screen'),
    essayMenu: document.getElementById('essay-menu-screen'),
    writingContent: document.getElementById('writing-content-screen'),
    login: document.getElementById('login-screen'),
    category: document.getElementById('category-selection-screen'),
    quizList: document.getElementById('quiz-list-screen'),
    quiz: document.getElementById('quiz-screen'),
    results: document.getElementById('results-screen'),
  };
  const feedbackModal = document.getElementById('feedback-modal');

  const readingVocabBtn = document.getElementById('reading-vocab-btn');
  const speakingBtn = document.getElementById('speaking-btn');
  const writingBtn = document.getElementById('writing-btn');
  const essaysMenuBtn = document.getElementById('essays-menu-btn');
  const backToHomeBtns = document.querySelectorAll('.back-to-home-btn');
  const backToHomeFromCategoryBtn = document.getElementById('back-to-home-from-category-btn');
  const backToWritingMenuBtn = document.getElementById('back-to-writing-menu-btn');
  const backToWritingMenuFromContentBtn = document.getElementById('back-to-writing-menu-from-content-btn');
  const writingContentTitle = document.getElementById('writing-content-title');
  const writingContentArea = document.getElementById('writing-content-area');

  const nameInput = document.getElementById('name-input');
  const loginBtn = document.getElementById('login-btn');
  const userNameDisplay = document.getElementById('user-name-display');
  const vocabBtn = document.getElementById('vocab-btn');
  const readingBtn = document.getElementById('reading-btn');
  const categoryTitle = document.getElementById('category-title');
  const quizListContainer = document.getElementById('quiz-list');
  const historyList = document.getElementById('history-list');
  const backToCategoryBtn = document.getElementById('back-to-category-btn');
  const quizTitle = document.getElementById('quiz-title');
  const questionCounter = document.getElementById('question-counter');
  const progressBar = document.getElementById('progress-bar');
  const timerDisplay = document.getElementById('timer');
  const questionText = document.getElementById('question-text');
  const optionsContainer = document.getElementById('options-container');
  const feedbackTitle = document.getElementById('feedback-title');
  const feedbackExplanation = document.getElementById('feedback-explanation');
  const nextQuestionBtn = document.getElementById('next-question-btn');
  const scoreText = document.getElementById('score-text');
  const percentageText = document.getElementById('percentage-text');
  const backToMenuBtn = document.getElementById('back-to-menu-btn');

  let currentUser = '';
  let allQuizzesData = [];
  let currentQuizData = null;
  let currentQuestionIndex = 0;
  let score = 0;
  let timerInterval;
  const TIME_LIMIT = 25;

  function showScreen(name){ Object.values(screens).forEach(s=>s.classList.add('hidden')); screens[name].classList.remove('hidden'); }

  async function loadWritingContent(filePath,title){
    showScreen('writingContent');
    writingContentTitle.textContent = title;
    writingContentArea.innerHTML = '<div class="loader mx-auto"></div>';
    try{
      const res = await fetch(filePath);
      if(!res.ok) throw new Error(`Kh√¥ng t√¨m th·∫•y file: ${res.statusText}`);
      const html = await res.text();
      writingContentArea.innerHTML = html;
    }catch(err){
      console.error('L·ªói t·∫£i n·ªôi dung:', err);
      writingContentArea.innerHTML = `<p class="text-rose-600">L·ªói: Kh√¥ng th·ªÉ t·∫£i n·ªôi dung. Ki·ªÉm tra l·∫°i ƒë∆∞·ªùng d·∫´n trong th∆∞ m·ª•c 'writing-samples'.</p>`;
    }
  }

  readingVocabBtn.addEventListener('click',()=>showScreen('login'));
  speakingBtn.addEventListener('click',()=>showScreen('speaking'));
  writingBtn.addEventListener('click',()=>showScreen('writingMenu'));
  essaysMenuBtn.addEventListener('click',()=>showScreen('essayMenu'));

  backToHomeBtns.forEach(btn=>btn.addEventListener('click',()=>showScreen('home')));
  backToHomeFromCategoryBtn?.addEventListener('click',()=>showScreen('home'));
  backToWritingMenuBtn?.addEventListener('click',()=>showScreen('writingMenu'));
  backToWritingMenuFromContentBtn?.addEventListener('click',()=>showScreen('writingMenu'));

  loginBtn.addEventListener('click', handleLogin);
  nameInput.addEventListener('keyup', (e)=>{ if(e.key==='Enter') handleLogin(); });
  vocabBtn.addEventListener('click',()=>showQuizCategory('Vocabulary', vocabularyQuizFiles));
  readingBtn.addEventListener('click',()=>showQuizCategory('Reading', readingQuizFiles));
  backToCategoryBtn.addEventListener('click',()=>showScreen('category'));
  nextQuestionBtn.addEventListener('click',()=>{ feedbackModal.classList.add('hidden'); currentQuestionIndex++; displayQuestion(); });
  backToMenuBtn.addEventListener('click',()=>showScreen('home'));

  function loadUserData(){ const saved=localStorage.getItem('vocabQuizUser'); if(saved){ currentUser=saved; nameInput.value=saved; } }
  function getUserHistory(){ const h=JSON.parse(localStorage.getItem('vocabQuizHistory'))||{}; return h[currentUser]||{}; }
  function saveUserHistory(id, userScore, total){
    const h=JSON.parse(localStorage.getItem('vocabQuizHistory'))||{};
    if(!h[currentUser]) h[currentUser]={};
    h[currentUser][id]={score:userScore,total:total,date:new Date().toLocaleString('vi-VN')};
    localStorage.setItem('vocabQuizHistory', JSON.stringify(h));
  }
  async function fetchAllQuizzes(){
    if(allQuizzesData.length>0) return;
    try{
      const files=[...vocabularyQuizFiles,...readingQuizFiles];
      const ps=files.map(f=>fetch(f).then(r=>{ if(!r.ok) throw new Error(`Cannot fetch ${f}`); return r.json(); }));
      allQuizzesData=await Promise.all(ps);
    }catch(e){ console.error("Failed to load quiz data:",e); alert("L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu quiz."); }
  }
  async function handleLogin(){
    const name=nameInput.value.trim();
    if(name){
      currentUser=name; localStorage.setItem('vocabQuizUser', currentUser);
      userNameDisplay.textContent=currentUser; await fetchAllQuizzes(); showScreen('category');
    }else alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
  }
  function showQuizCategory(category, files){
    populateQuizList(category, files);
    const ids=files.map(f=>f.split('/').pop().replace('.json',''));
    displayUserHistory(ids);
    showScreen('quizList');
  }
  function startQuiz(id){
    currentQuizData = allQuizzesData.find(q=>q.id===id);
    if(!currentQuizData) return;
    currentQuestionIndex=0; score=0;
    shuffledQuestions=[...currentQuizData.questions].sort(()=>Math.random()-0.5);
    quizTitle.textContent=currentQuizData.title;
    showScreen('quiz'); displayQuestion();
  }
  function displayQuestion(){
    if(currentQuestionIndex>=shuffledQuestions.length){ showResults(); return; }
    const q=shuffledQuestions[currentQuestionIndex];
    progressBar.style.width=`${((currentQuestionIndex+1)/shuffledQuestions.length)*100}%`;
    questionCounter.textContent=`C√¢u ${currentQuestionIndex+1}/${shuffledQuestions.length}`;
    if(q.sentence && q.instruction){
      questionText.innerHTML=`<div class="w-full flex flex-col items-center"><p class="font-semibold text-lg md:text-xl mb-3">${q.instruction}</p><p class="italic text-slate-700 text-xl md:text-2xl">"${q.sentence}"</p></div>`;
    }else{
      questionText.innerHTML=`<div class="w-full">${q.question}</div>`;
    }
    optionsContainer.innerHTML='';
    q.options.forEach(opt=>{
      const btn=document.createElement('button');
      btn.innerHTML=opt;
      btn.className='option-btn w-full bg-slate-100 hover:bg-slate-200 text-slate-800 border border-slate-300 font-medium py-4 px-4 rounded-lg transition';
      btn.addEventListener('click',()=>handleAnswer(opt,btn));
      optionsContainer.appendChild(btn);
    });
    startTimer();
  }
  function handleAnswer(selected, btn){
    clearInterval(timerInterval);
    const q=shuffledQuestions[currentQuestionIndex];
    const ok=selected===q.answer;
    if(ok){ feedbackTitle.textContent="Ch√≠nh x√°c!"; feedbackTitle.className="text-3xl font-bold mb-4 text-green-600"; }
    else { feedbackTitle.textContent="Ch∆∞a ƒë√∫ng!"; feedbackTitle.className="text-3xl font-bold mb-4 text-rose-600"; }
    feedbackExplanation.innerHTML=`<b>ƒê√°p √°n ƒë√∫ng:</b> ${q.answer}<br><br>${q.explanation_vi}`;
    Array.from(optionsContainer.children).forEach(b=>{
      b.disabled=true;
      if(b.innerHTML===q.answer) b.classList.add('correct');
      else if(b===btn) b.classList.add('incorrect');
    });
    setTimeout(()=>feedbackModal.classList.remove('hidden'), 600);
  }
  function showResults(){
    const total=shuffledQuestions.length;
    const pct = total>0 ? ((score/total)*100).toFixed(0) : 0;
    scoreText.textContent = `${score}/${total}`;
    percentageText.textContent = `(${pct}%)`;
    saveUserHistory(currentQuizData.id, score, total);
    showScreen('results');
  }
  function startTimer(){ /* gi·ªØ nguy√™n ph·∫ßn c≈© c·ªßa b·∫°n ho·∫∑c ch√®n l·∫°i ·ªü ƒë√¢y */ }
  function populateQuizList(category, files){ /* gi·ªØ nguy√™n ph·∫ßn c≈© */ }
  function displayUserHistory(ids){ /* gi·ªØ nguy√™n ph·∫ßn c≈© */ }

  loadUserData();
  showScreen('home');
  </script>
</body>
</html>
