<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B1 English Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .option-btn.correct { background-color: #22c55e !important; border-color: #16a34a !important; }
        .option-btn.incorrect { background-color: #ef4444 !important; border-color: #dc2626 !important; }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db;
            width: 40px; height: 40px; animation: spin 2s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #writing-content-area h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #67e8f9; }
        #writing-content-area h3 { font-size: 1.25rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #a5b4fc; }
        #writing-content-area p { margin-bottom: 1rem; line-height: 1.6; }
        #writing-content-area ul { list-style: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <div id="home-screen" class="text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h1 class="text-4xl font-bold mb-2 text-cyan-400">B1 English Practice</h1>
            <p class="text-gray-300 mb-8">Ch·ªçn m·ªôt m·ª•c ƒë·ªÉ luy·ªán t·∫≠p</p>
            <div class="flex flex-col gap-6 justify-center">
                <button id="reading-vocab-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-6 px-10 rounded-lg text-2xl transition duration-300 transform hover:scale-105">üß† Reading & Vocabulary Quizzes</button>
                <button id="speaking-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-6 px-10 rounded-lg text-2xl transition duration-300 transform hover:scale-105">üó£Ô∏è Speaking Samples</button>
                <button id="writing-btn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-6 px-10 rounded-lg text-2xl transition duration-300 transform hover:scale-105">‚úçÔ∏è Writing Samples</button>
            </div>
        </div>
        
        <div id="speaking-screen" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold mb-6 text-indigo-400">Speaking Samples</h2>
            <div class="text-gray-300 bg-gray-700 p-6 rounded-lg min-h-[200px]">
                <p>N·ªôi dung ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t. Vui l√≤ng quay l·∫°i sau!</p>
            </div>
            <button class="back-to-home-btn mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg text-lg transition duration-300">Quay v·ªÅ Trang ch√≠nh</button>
        </div>

        <div id="writing-menu-screen" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold mb-6 text-rose-400">Writing Samples</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="loadWritingContent('writing-samples/informal-letters.html', 'Th∆∞ Th√¢n M·∫≠t')" class="bg-gray-700 hover:bg-rose-800 p-6 rounded-lg text-xl">Informal Letters</button>
                <button onclick="loadWritingContent('writing-samples/formal-letters.html', 'Th∆∞ Trang Tr·ªçng')" class="bg-gray-700 hover:bg-rose-800 p-6 rounded-lg text-xl">Formal Letters</button>
                <button id="essays-menu-btn" class="md:col-span-2 bg-gray-700 hover:bg-rose-800 p-6 rounded-lg text-xl font-bold">Essays</button>
            </div>
            <button class="back-to-home-btn mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg text-lg transition duration-300">Quay v·ªÅ Trang ch√≠nh</button>
        </div>
        
        <div id="essay-menu-screen" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
             <h2 class="text-3xl font-bold mb-6 text-rose-400">Essay Types</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="loadWritingContent('writing-samples/opinion-essay.html', 'Opinion Essay')" class="bg-gray-700 hover:bg-rose-800 p-4 rounded-lg">Opinion (Agree/Disagree)</button>
                <button onclick="loadWritingContent('writing-samples/discuss-essay.html', 'Discussion Essay')" class="bg-gray-700 hover:bg-rose-800 p-4 rounded-lg">Discuss Both Views</button>
                <button onclick="loadWritingContent('writing-samples/advantages-essay.html', 'Advantages/Disadvantages Essay')" class="bg-gray-700 hover:bg-rose-800 p-4 rounded-lg">Advantages & Disadvantages</button>
                <button onclick="loadWritingContent('writing-samples/two-part-essay.html', 'Two-Part Question Essay')" class="bg-gray-700 hover:bg-rose-800 p-4 rounded-lg">Two-Part Questions</button>
             </div>
             <button id="back-to-writing-menu-btn" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg text-lg transition duration-300">Quay l·∫°i Menu Writing</button>
        </div>

        <div id="writing-content-screen" class="hidden bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 id="writing-content-title" class="text-3xl font-bold mb-6 text-rose-400"></h2>
            <div id="writing-content-area" class="bg-gray-900 p-6 rounded-lg text-left max-h-[60vh] overflow-y-auto text-gray-300">
                <div class="loader mx-auto"></div>
            </div>
            <button id="back-to-writing-menu-from-content-btn" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg text-lg transition duration-300">Quay l·∫°i Menu Writing</button>
        </div>
        <div id="login-screen" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h1 class="text-4xl font-bold mb-2 text-cyan-400">B1 English Quizzes</h1>
            <p class="text-gray-300 mb-6">Luy·ªán t·∫≠p Vocabulary & Reading m·ªói ng√†y!</p>
            <input type="text" id="name-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." class="w-full max-w-sm mx-auto bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-4 py-3 text-lg mb-4 focus:outline-none focus:ring-2 focus:ring-cyan-500">
            <button id="login-btn" class="w-full max-w-sm mx-auto bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">B·∫Øt ƒë·∫ßu</button>
        </div>

        <div id="category-selection-screen" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold mb-8">Ch√†o <span id="user-name-display" class="text-cyan-400"></span>, ch·ªçn m·ªôt chuy√™n m·ª•c:</h2>
            <div class="flex flex-col md:flex-row gap-6 justify-center">
                <button id="vocab-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-6 px-10 rounded-lg text-2xl transition duration-300 transform hover:scale-105">üìù Vocabulary</button>
                <button id="reading-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-6 px-10 rounded-lg text-2xl transition duration-300 transform hover:scale-105">üìñ Reading</button>
            </div>
             <button id="back-to-home-from-category-btn" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg text-lg transition duration-300">Quay v·ªÅ Trang ch√≠nh</button>
        </div>
        <div id="quiz-list-screen" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 id="category-title" class="text-3xl font-bold mb-6"></h2>
            <div id="quiz-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[150px] flex items-center justify-center"><div class="loader"></div></div>
            <div id="history-container" class="mt-8">
                <h3 class="text-2xl font-bold mb-4">L·ªãch s·ª≠ l√†m b√†i (chuy√™n m·ª•c n√†y)</h3>
                <div id="history-list" class="bg-gray-700 p-4 rounded-lg text-left max-h-60 overflow-y-auto"></div>
            </div>
            <button id="back-to-category-btn" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg text-lg transition duration-300">Quay l·∫°i</button>
        </div>
        <div id="quiz-screen" class="hidden bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl">
            <div class="mb-6"><div class="flex justify-between items-center mb-2"><span id="quiz-title" class="text-xl md:text-2xl font-bold text-cyan-400"></span><span id="question-counter" class="text-lg font-semibold"></span></div><div class="w-full bg-gray-700 rounded-full h-4"><div id="progress-bar" class="bg-cyan-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div></div></div>
            <div class="text-center mb-6"><div id="timer" class="text-5xl font-bold text-yellow-400">25</div></div>
            <div id="question-container" class="mb-6"><div id="question-text" class="text-xl md:text-2xl text-center font-medium min-h-[100px] flex items-center justify-center"></div></div>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
        <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
            <div id="feedback-content" class="bg-gray-800 rounded-xl shadow-2xl p-8 max-w-lg w-full text-center">
                <h3 id="feedback-title" class="text-3xl font-bold mb-4"></h3><p id="feedback-explanation" class="text-lg text-gray-300"></p>
                <button id="next-question-btn" class="mt-6 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300">Ti·∫øp theo</button>
            </div>
        </div>
        <div id="results-screen" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 class="text-4xl font-bold mb-4 text-cyan-400">Ho√†n th√†nh!</h2><p class="text-2xl mb-2">K·∫øt qu·∫£ c·ªßa b·∫°n:</p><p id="score-text" class="text-6xl font-bold mb-6 text-yellow-400"></p><p id="percentage-text" class="text-xl mb-8"></p>
            <button id="back-to-menu-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">Quay v·ªÅ Menu</button>
        </div>

    </div>

    <script>
    // C·∫•u h√¨nh Quiz
    const vocabularyQuizFiles = ['quizzes/vocabulary/cam18_t1.json', 'quizzes/vocabulary/cam18_t2.json', 'quizzes/vocabulary/cam18_t3.json'];
    const readingQuizFiles = [];

    // Logic ·ª©ng d·ª•ng
    const screens = {
        home: document.getElementById('home-screen'),
        speaking: document.getElementById('speaking-screen'),
        writingMenu: document.getElementById('writing-menu-screen'),
        essayMenu: document.getElementById('essay-menu-screen'),
        writingContent: document.getElementById('writing-content-screen'),
        login: document.getElementById('login-screen'),
        category: document.getElementById('category-selection-screen'),
        quizList: document.getElementById('quiz-list-screen'),
        quiz: document.getElementById('quiz-screen'),
        results: document.getElementById('results-screen'),
    };
    const feedbackModal = document.getElementById('feedback-modal');
    
    // DOM Elements
    const readingVocabBtn = document.getElementById('reading-vocab-btn');
    const speakingBtn = document.getElementById('speaking-btn');
    const writingBtn = document.getElementById('writing-btn');
    const essaysMenuBtn = document.getElementById('essays-menu-btn');
    const backToHomeBtns = document.querySelectorAll('.back-to-home-btn');
    const backToHomeFromCategoryBtn = document.getElementById('back-to-home-from-category-btn');
    const backToWritingMenuBtn = document.getElementById('back-to-writing-menu-btn');
    const backToWritingMenuFromContentBtn = document.getElementById('back-to-writing-menu-from-content-btn');
    const writingContentTitle = document.getElementById('writing-content-title');
    const writingContentArea = document.getElementById('writing-content-area');

    // ... (c√°c DOM elements kh√°c c·ªßa quiz)
    const nameInput = document.getElementById('name-input');
    const loginBtn = document.getElementById('login-btn');
    const userNameDisplay = document.getElementById('user-name-display');
    const vocabBtn = document.getElementById('vocab-btn');
    const readingBtn = document.getElementById('reading-btn');
    const categoryTitle = document.getElementById('category-title');
    const quizListContainer = document.getElementById('quiz-list');
    const historyList = document.getElementById('history-list');
    const backToCategoryBtn = document.getElementById('back-to-category-btn');
    const quizTitle = document.getElementById('quiz-title');
    const questionCounter = document.getElementById('question-counter');
    const progressBar = document.getElementById('progress-bar');
    const timerDisplay = document.getElementById('timer');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackExplanation = document.getElementById('feedback-explanation');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const scoreText = document.getElementById('score-text');
    const percentageText = document.getElementById('percentage-text');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');

    // App State
    let currentUser = '';
    let allQuizzesData = [];
    let currentQuizData = null;
    let currentQuestionIndex = 0;
    let score = 0;
    let timerInterval;
    const TIME_LIMIT = 25;

    function showScreen(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
    }

    // === H√ÄM M·ªöI ƒê·ªÇ T·∫¢I N·ªòI DUNG WRITING ===
    async function loadWritingContent(filePath, title) {
        showScreen('writingContent');
        writingContentTitle.textContent = title;
        writingContentArea.innerHTML = '<div class="loader mx-auto"></div>'; // Hi·ªÉn th·ªã loading

        try {
            const response = await fetch(filePath);
            if (!response.ok) {
                throw new Error(`Kh√¥ng t√¨m th·∫•y file: ${response.statusText}`);
            }
            const htmlContent = await response.text();
            writingContentArea.innerHTML = htmlContent;
        } catch (error) {
            console.error('L·ªói t·∫£i n·ªôi dung:', error);
            writingContentArea.innerHTML = `<p class="text-red-400">L·ªói: Kh√¥ng th·ªÉ t·∫£i ƒë∆∞·ª£c n·ªôi dung. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng d·∫´n file trong th∆∞ m·ª•c 'writing-samples'.</p>`;
        }
    }

    // Event Listeners ch√≠nh
    readingVocabBtn.addEventListener('click', () => showScreen('login'));
    speakingBtn.addEventListener('click', () => showScreen('speaking'));
    writingBtn.addEventListener('click', () => showScreen('writingMenu'));
    essaysMenuBtn.addEventListener('click', () => showScreen('essayMenu'));
    
    backToHomeBtns.forEach(btn => btn.addEventListener('click', () => showScreen('home')));
    backToHomeFromCategoryBtn.addEventListener('click', () => showScreen('home'));
    backToWritingMenuBtn.addEventListener('click', () => showScreen('writingMenu'));
    backToWritingMenuFromContentBtn.addEventListener('click', () => showScreen('writingMenu'));

    // ... (to√†n b·ªô c√°c h√†m v√† event listener c·ªßa ph·∫ßn quiz gi·ªØ nguy√™n)
    loginBtn.addEventListener('click', handleLogin);
    nameInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleLogin(); });
    vocabBtn.addEventListener('click', () => showQuizCategory('Vocabulary', vocabularyQuizFiles));
    readingBtn.addEventListener('click', () => showQuizCategory('Reading', readingQuizFiles));
    backToCategoryBtn.addEventListener('click', () => showScreen('category'));
    nextQuestionBtn.addEventListener('click', () => { feedbackModal.classList.add('hidden'); currentQuestionIndex++; displayQuestion(); });
    backToMenuBtn.addEventListener('click', () => showScreen('home'));

    function loadUserData() {
        const savedUser = localStorage.getItem('vocabQuizUser');
        if (savedUser) { currentUser = savedUser; nameInput.value = savedUser; }
    }
    function getUserHistory() { const history = JSON.parse(localStorage.getItem('vocabQuizHistory')) || {}; return history[currentUser] || {}; }
    function saveUserHistory(quizId, userScore, totalQuestions) {
        const history = JSON.parse(localStorage.getItem('vocabQuizHistory')) || {};
        if (!history[currentUser]) { history[currentUser] = {}; }
        history[currentUser][quizId] = { score: userScore, total: totalQuestions, date: new Date().toLocaleString('vi-VN') };
        localStorage.setItem('vocabQuizHistory', JSON.stringify(history));
    }
    async function fetchAllQuizzes() {
        if (allQuizzesData.length > 0) return;
        try {
            const allQuizFiles = [...vocabularyQuizFiles, ...readingQuizFiles];
            const quizPromises = allQuizFiles.map(file => fetch(file).then(res => { if (!res.ok) throw new Error(`Cannot fetch ${file}`); return res.json(); }));
            allQuizzesData = await Promise.all(quizPromises);
        } catch (error) { console.error("Failed to load quiz data:", error); alert("L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu quiz."); }
    }
    async function handleLogin() {
        const name = nameInput.value.trim();
        if (name) { currentUser = name; localStorage.setItem('vocabQuizUser', currentUser); userNameDisplay.textContent = currentUser; await fetchAllQuizzes(); showScreen('category');
        } else { alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!'); }
    }
    function showQuizCategory(category, files) {
        populateQuizList(category, files);
        const quizIds = files.map(file => file.split('/').pop().replace('.json', ''));
        displayUserHistory(quizIds);
        showScreen('quizList');
    }
    function startQuiz(quizId) {
        currentQuizData = allQuizzesData.find(q => q.id === quizId);
        if (!currentQuizData) return;
        currentQuestionIndex = 0;
        score = 0;
        shuffledQuestions = [...currentQuizData.questions].sort(() => Math.random() - 0.5);
        quizTitle.textContent = currentQuizData.title;
        showScreen('quiz');
        displayQuestion();
    }
    function displayQuestion() {
        if (currentQuestionIndex >= shuffledQuestions.length) { showResults(); return; }
        const question = shuffledQuestions[currentQuestionIndex];
        progressBar.style.width = `${((currentQuestionIndex + 1) / shuffledQuestions.length) * 100}%`;
        questionCounter.textContent = `C√¢u ${currentQuestionIndex + 1}/${shuffledQuestions.length}`;
        if (question.sentence && question.instruction) { questionText.innerHTML = `<div class="w-full flex flex-col items-center"><p class="font-semibold text-lg md:text-xl mb-3">${question.instruction}</p><p class="italic text-gray-300 text-xl md:text-2xl">"${question.sentence}"</p></div>`; } 
        else { questionText.innerHTML = `<div class="w-full">${question.question}</div>`; }
        optionsContainer.innerHTML = '';
        question.options.forEach(option => {
            const button = document.createElement('button');
            button.innerHTML = option;
            button.className = 'option-btn w-full bg-gray-700 hover:bg-cyan-800 text-white font-semibold py-4 px-4 rounded-lg transition duration-300 text-lg';
            button.addEventListener('click', () => handleAnswer(option, button));
            optionsContainer.appendChild(button);
        });
        startTimer();
    }
    function handleAnswer(selectedOption, selectedButton) {
        clearInterval(timerInterval);
        const question = shuffledQuestions[currentQuestionIndex];
        const isCorrect = selectedOption === question.answer;
        if (isCorrect) { score++; feedbackTitle.textContent = "Ch√≠nh x√°c!"; feedbackTitle.className = "text-3xl font-bold mb-4 text-green-400"; } 
        else { feedbackTitle.textContent = "Ch∆∞a ƒë√∫ng!"; feedbackTitle.className = "text-3xl font-bold mb-4 text-red-400"; }
        feedbackExplanation.innerHTML = `<b>ƒê√°p √°n ƒë√∫ng:</b> ${question.answer}<br><br>${question.explanation_vi}`;
        Array.from(optionsContainer.children).forEach(btn => {
            btn.disabled = true;
            if (btn.innerHTML === question.answer) btn.classList.add('correct');
            else if (btn === selectedButton) btn.classList.add('incorrect');
        });
        setTimeout(() => feedbackModal.classList.remove('hidden'), 1000);
    }
    function showResults() {
        const totalQuestions = shuffledQuestions.length;
        const percentage = totalQuestions > 0 ? ((score / totalQuestions) * 100).toFixed(0) : 0;
        scoreText.textContent = `${score}/${totalQuestions}`;
        percentageText.textContent = `(${percentage}%)`;
        saveUserHistory(currentQuizData.id, score, totalQuestions);
        showScreen('results');
    }
    function startTimer() { /* ... function content from previous version ... */ }
    function populateQuizList(category, files) { /* ... function content from previous version ... */ }
    function displayUserHistory(quizIds) { /* ... function content from previous version ... */ }
    // (Sao ch√©p v√† d√°n c√°c h√†m c√≤n l·∫°i c·ªßa quiz: startTimer, populateQuizList, displayUserHistory v√†o ƒë√¢y)
    
    // Kh·ªüi t·∫°o
    loadUserData();
    showScreen('home');
    </script>
</body>
</html>
