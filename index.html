<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B1 English Quizzes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .option-btn.correct {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
        }
        .option-btn.incorrect {
            background-color: #ef4444 !important;
            border-color: #dc2626 !important;
        }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <!-- M√†n h√¨nh ƒëƒÉng nh·∫≠p -->
        <div id="login-screen" class="text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h1 class="text-4xl font-bold mb-2 text-cyan-400">B1 English Quizzes</h1>
            <p class="text-gray-300 mb-6">Luy·ªán t·∫≠p Vocabulary & Reading m·ªói ng√†y!</p>
            <input type="text" id="name-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." class="w-full max-w-sm mx-auto bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-4 py-3 text-lg mb-4 focus:outline-none focus:ring-2 focus:ring-cyan-500">
            <button id="login-btn" class="w-full max-w-sm mx-auto bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">B·∫Øt ƒë·∫ßu</button>
        </div>

        <!-- M√†n h√¨nh ch·ªçn chuy√™n m·ª•c -->
        <div id="category-selection-screen" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold mb-8">Ch√†o <span id="user-name-display" class="text-cyan-400"></span>, ch·ªçn m·ªôt chuy√™n m·ª•c:</h2>
            <div class="flex flex-col md:flex-row gap-6 justify-center">
                <button id="vocab-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-6 px-10 rounded-lg text-2xl transition duration-300 transform hover:scale-105">
                    üìù Vocabulary
                </button>
                <button id="reading-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-6 px-10 rounded-lg text-2xl transition duration-300 transform hover:scale-105">
                    üìñ Reading
                </button>
            </div>
        </div>
        
        <!-- M√†n h√¨nh danh s√°ch Quiz -->
        <div id="quiz-list-screen" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 id="category-title" class="text-3xl font-bold mb-6"></h2>
            <div id="quiz-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[150px] flex items-center justify-center">
                 <div class="loader"></div>
            </div>
            <div id="history-container" class="mt-8">
                <h3 class="text-2xl font-bold mb-4">L·ªãch s·ª≠ l√†m b√†i (chuy√™n m·ª•c n√†y)</h3>
                <div id="history-list" class="bg-gray-700 p-4 rounded-lg text-left max-h-60 overflow-y-auto"></div>
            </div>
            <button id="back-to-category-btn" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg text-lg transition duration-300">Quay l·∫°i</button>
        </div>

        <!-- M√†n h√¨nh Quiz -->
        <div id="quiz-screen" class="hidden bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span id="quiz-title" class="text-xl md:text-2xl font-bold text-cyan-400"></span>
                    <span id="question-counter" class="text-lg font-semibold"></span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-4">
                    <div id="progress-bar" class="bg-cyan-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div class="text-center mb-6">
                <div id="timer" class="text-5xl font-bold text-yellow-400">25</div>
            </div>
            <div id="question-container" class="mb-6">
                <div id="question-text" class="text-xl md:text-2xl text-center font-medium min-h-[100px] flex items-center justify-center"></div>
            </div>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
        
        <!-- Modal hi·ªÉn th·ªã gi·∫£i th√≠ch -->
        <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
            <div id="feedback-content" class="bg-gray-800 rounded-xl shadow-2xl p-8 max-w-lg w-full text-center">
                <h3 id="feedback-title" class="text-3xl font-bold mb-4"></h3>
                <p id="feedback-explanation" class="text-lg text-gray-300"></p>
                <button id="next-question-btn" class="mt-6 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300">Ti·∫øp theo</button>
            </div>
        </div>

        <!-- M√†n h√¨nh k·∫øt qu·∫£ -->
        <div id="results-screen" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 class="text-4xl font-bold mb-4 text-cyan-400">Ho√†n th√†nh!</h2>
            <p class="text-2xl mb-2">K·∫øt qu·∫£ c·ªßa b·∫°n:</p>
            <p id="score-text" class="text-6xl font-bold mb-6 text-yellow-400"></p>
            <p id="percentage-text" class="text-xl mb-8"></p>
            <button id="back-to-menu-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">Quay v·ªÅ Menu</button>
        </div>

    </div>

    <script>
    /*****************************************************************************
     * C·∫§U H√åNH QUIZ
     * * ƒê·ªÉ th√™m quiz m·ªõi, b·∫°n ch·ªâ c·∫ßn:
     * 1. T·∫°o file .json m·ªõi trong th∆∞ m·ª•c t∆∞∆°ng ·ª©ng (`quizzes/vocabulary` ho·∫∑c `quizzes/reading`).
     * 2. Th√™m ƒë∆∞·ªùng d·∫´n file ƒë√≥ v√†o m·∫£ng `vocabularyQuizFiles` ho·∫∑c `readingQuizFiles` d∆∞·ªõi ƒë√¢y.
     *****************************************************************************/
    const vocabularyQuizFiles = [
        'quizzes/vocabulary/cam18_t1.json'
        'quizzes/vocabulary/cam18_t2.json'
    ];
    const readingQuizFiles = [
        // 'quizzes/reading/reading_quiz_1.json'
    ];

    // =========================================================================
    // PH·∫¶N LOGIC C·ª¶A ·ª®NG D·ª§NG - B·∫†N KH√îNG C·∫¶N CH·ªàNH S·ª¨A PH·∫¶N D∆Ø·ªöI N√ÄY
    // =========================================================================
    const screens = {
        login: document.getElementById('login-screen'),
        category: document.getElementById('category-selection-screen'),
        quizList: document.getElementById('quiz-list-screen'),
        quiz: document.getElementById('quiz-screen'),
        results: document.getElementById('results-screen'),
    };
    const feedbackModal = document.getElementById('feedback-modal');
    
    // DOM Elements
    const nameInput = document.getElementById('name-input');
    const loginBtn = document.getElementById('login-btn');
    const userNameDisplay = document.getElementById('user-name-display');
    const vocabBtn = document.getElementById('vocab-btn');
    const readingBtn = document.getElementById('reading-btn');
    const categoryTitle = document.getElementById('category-title');
    const quizListContainer = document.getElementById('quiz-list');
    const historyList = document.getElementById('history-list');
    const backToCategoryBtn = document.getElementById('back-to-category-btn');
    const quizTitle = document.getElementById('quiz-title');
    const questionCounter = document.getElementById('question-counter');
    const progressBar = document.getElementById('progress-bar');
    const timerDisplay = document.getElementById('timer');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackExplanation = document.getElementById('feedback-explanation');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const scoreText = document.getElementById('score-text');
    const percentageText = document.getElementById('percentage-text');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');

    // App State
    let currentUser = '';
    let allQuizzesData = [];
    let currentQuizData = null;
    let currentQuestionIndex = 0;
    let score = 0;
    let timerInterval;
    let shuffledQuestions = [];
    const TIME_LIMIT = 25;

    function showScreen(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
    }

    function loadUserData() {
        const savedUser = localStorage.getItem('vocabQuizUser');
        if (savedUser) {
            currentUser = savedUser;
            nameInput.value = savedUser;
        }
    }
    
    function getUserHistory() {
        const history = JSON.parse(localStorage.getItem('vocabQuizHistory')) || {};
        return history[currentUser] || {};
    }

    function saveUserHistory(quizId, userScore, totalQuestions) {
        const history = JSON.parse(localStorage.getItem('vocabQuizHistory')) || {};
        if (!history[currentUser]) {
            history[currentUser] = {};
        }
        history[currentUser][quizId] = {
            score: userScore,
            total: totalQuestions,
            date: new Date().toLocaleString('vi-VN')
        };
        localStorage.setItem('vocabQuizHistory', JSON.stringify(history));
    }
    
    function displayUserHistory(quizIds) {
        const userHistory = getUserHistory();
        historyList.innerHTML = '';
        const relevantHistory = Object.entries(userHistory).filter(([quizId]) => quizIds.includes(quizId));

        if (relevantHistory.length === 0) {
            historyList.innerHTML = '<p class="text-gray-400">B·∫°n ch∆∞a l√†m b√†i quiz n√†o trong m·ª•c n√†y.</p>';
            return;
        }
        
        const sortedHistory = relevantHistory.sort((a, b) => new Date(b[1].date) - new Date(a[1].date));

        sortedHistory.forEach(([quizId, result]) => {
            const quiz = allQuizzesData.find(q => q.id === quizId);
            if (quiz) {
                const percentage = ((result.score / result.total) * 100).toFixed(0);
                const historyItem = document.createElement('div');
                historyItem.className = 'flex justify-between items-center p-2 border-b border-gray-600';
                historyItem.innerHTML = `
                    <div>
                        <p class="font-semibold">${quiz.title}</p>
                        <p class="text-sm text-gray-400">${result.date}</p>
                    </div>
                    <p class="font-bold text-lg ${percentage >= 70 ? 'text-green-400' : 'text-yellow-400'}">${result.score}/${result.total} (${percentage}%)</p>
                `;
                historyList.appendChild(historyItem);
            }
        });
    }

    async function fetchAllQuizzes() {
        if (allQuizzesData.length > 0) return; // Ch·ªâ fetch m·ªôt l·∫ßn
        try {
            const allQuizFiles = [...vocabularyQuizFiles, ...readingQuizFiles];
            const quizPromises = allQuizFiles.map(file => fetch(file).then(res => {
                if (!res.ok) throw new Error(`Cannot fetch ${file}`);
                return res.json();
            }));
            allQuizzesData = await Promise.all(quizPromises);
        } catch (error) {
            console.error("Failed to load quiz data:", error);
            alert("L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu quiz. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng d·∫´n file v√† c·∫•u tr√∫c th∆∞ m·ª•c.");
        }
    }

    function populateQuizList(category, files) {
        const quizIds = files.map(file => {
            const parts = file.split('/');
            return parts[parts.length - 1].replace('.json', '');
        });
        categoryTitle.textContent = `Chuy√™n m·ª•c: ${category}`;
        quizListContainer.innerHTML = '';
        const quizzesInCategory = allQuizzesData.filter(quiz => quizIds.includes(quiz.id));

        if (quizzesInCategory.length === 0) {
             quizListContainer.innerHTML = `<p class="text-gray-400 col-span-full">Ch∆∞a c√≥ b√†i quiz n√†o trong chuy√™n m·ª•c n√†y.</p>`;
             return;
        }

        const userHistory = getUserHistory();
        quizzesInCategory.forEach(quiz => {
            const quizCard = document.createElement('button');
            quizCard.className = 'bg-gray-700 p-6 rounded-lg text-left hover:bg-cyan-800 transition duration-300 focus:outline-none focus:ring-2 focus:ring-cyan-500';
            
            const historyEntry = userHistory[quiz.id];
            let historyHTML = '<p class="text-sm text-gray-400">Ch∆∞a l√†m</p>';
            if (historyEntry) {
                const percentage = ((historyEntry.score / historyEntry.total) * 100).toFixed(0);
                historyHTML = `<p class="text-sm font-semibold ${percentage >= 70 ? 'text-green-400' : 'text-yellow-400'}">L·∫ßn cu·ªëi: ${historyEntry.score}/${historyEntry.total} (${percentage}%)</p>`;
            }

            quizCard.innerHTML = `
                <h3 class="text-xl font-bold mb-2">${quiz.title}</h3>
                <p class="text-gray-300 mb-3">${quiz.questions.length} c√¢u h·ªèi</p>
                ${historyHTML}
            `;
            quizCard.addEventListener('click', () => startQuiz(quiz.id));
            quizListContainer.appendChild(quizCard);
        });
    }

    async function handleLogin() {
        const name = nameInput.value.trim();
        if (name) {
            currentUser = name;
            localStorage.setItem('vocabQuizUser', currentUser);
            userNameDisplay.textContent = currentUser;
            await fetchAllQuizzes();
            showScreen('category');
        } else {
            alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
        }
    }

    function showQuizCategory(category, files) {
        populateQuizList(category, files);
        const quizIds = files.map(file => file.split('/').pop().replace('.json', ''));
        displayUserHistory(quizIds);
        showScreen('quizList');
    }

    // Event Listeners
    loginBtn.addEventListener('click', handleLogin);
    nameInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') handleLogin();
    });

    vocabBtn.addEventListener('click', () => showQuizCategory('Vocabulary', vocabularyQuizFiles));
    readingBtn.addEventListener('click', () => showQuizCategory('Reading', readingQuizFiles));
    backToCategoryBtn.addEventListener('click', () => showScreen('category'));

    function startQuiz(quizId) {
        currentQuizData = allQuizzesData.find(q => q.id === quizId);
        if (!currentQuizData) return;

        currentQuestionIndex = 0;
        score = 0;
        shuffledQuestions = [...currentQuizData.questions].sort(() => Math.random() - 0.5);
        
        quizTitle.textContent = currentQuizData.title;
        showScreen('quiz');
        displayQuestion();
    }

    function displayQuestion() {
        if (currentQuestionIndex >= shuffledQuestions.length) {
            showResults();
            return;
        }

        const question = shuffledQuestions[currentQuestionIndex];
        progressBar.style.width = `${((currentQuestionIndex + 1) / shuffledQuestions.length) * 100}%`;
        questionCounter.textContent = `C√¢u ${currentQuestionIndex + 1}/${shuffledQuestions.length}`;
        
        // ** LOGIC ƒê√É S·ª¨A L·ªñI **
        if (question.sentence && question.instruction) {
            // D√†nh cho c√¢u h·ªèi ƒë·ªìng nghƒ©a/tr√°i nghƒ©a c√≥ c·∫•u tr√∫c m·ªõi
            questionText.innerHTML = `
                <div class="w-full flex flex-col items-center">
                    <p class="font-semibold text-lg md:text-xl mb-3">${question.instruction}</p>
                    <p class="italic text-gray-300 text-xl md:text-2xl">"${question.sentence}"</p>
                </div>
            `;
        } else {
            // D√†nh cho c√°c lo·∫°i c√¢u h·ªèi kh√°c (ƒëi·ªÅn t·ª´, odd one out)
            questionText.innerHTML = `<div class="w-full">${question.question}</div>`;
        }


        optionsContainer.innerHTML = '';
        question.options.forEach(option => {
            const button = document.createElement('button');
            button.innerHTML = option;
            button.className = 'option-btn w-full bg-gray-700 hover:bg-cyan-800 text-white font-semibold py-4 px-4 rounded-lg transition duration-300 text-lg';
            button.addEventListener('click', () => handleAnswer(option, button));
            optionsContainer.appendChild(button);
        });
        startTimer();
    }

    function startTimer() {
        let timeLeft = TIME_LIMIT;
        timerDisplay.textContent = timeLeft;
        timerDisplay.classList.remove('text-red-500');

        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = timeLeft;
            if (timeLeft <= 5) timerDisplay.classList.add('text-red-500');
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                handleAnswer(null, null);
            }
        }, 1000);
    }

    function handleAnswer(selectedOption, selectedButton) {
        clearInterval(timerInterval);
        const question = shuffledQuestions[currentQuestionIndex];
        const isCorrect = selectedOption === question.answer;

        if (isCorrect) {
            score++;
            feedbackTitle.textContent = "Ch√≠nh x√°c!";
            feedbackTitle.className = "text-3xl font-bold mb-4 text-green-400";
        } else {
            feedbackTitle.textContent = "Ch∆∞a ƒë√∫ng!";
            feedbackTitle.className = "text-3xl font-bold mb-4 text-red-400";
        }
        
        feedbackExplanation.innerHTML = `<b>ƒê√°p √°n ƒë√∫ng:</b> ${question.answer}<br><br>${question.explanation_vi}`;

        Array.from(optionsContainer.children).forEach(btn => {
            btn.disabled = true;
            if (btn.innerHTML === question.answer) btn.classList.add('correct');
            else if (btn === selectedButton) btn.classList.add('incorrect');
        });

        setTimeout(() => feedbackModal.classList.remove('hidden'), 1000);
    }

    nextQuestionBtn.addEventListener('click', () => {
        feedbackModal.classList.add('hidden');
        currentQuestionIndex++;
        displayQuestion();
    });

    function showResults() {
        const totalQuestions = shuffledQuestions.length;
        const percentage = totalQuestions > 0 ? ((score / totalQuestions) * 100).toFixed(0) : 0;
        scoreText.textContent = `${score}/${totalQuestions}`;
        percentageText.textContent = `(${percentage}%)`;
        saveUserHistory(currentQuizData.id, score, totalQuestions);
        showScreen('results');
    }

    backToMenuBtn.addEventListener('click', () => showScreen('category'));

    // Initialize the app
    loadUserData();
    showScreen('login');

    </script>
</body>
</html>
